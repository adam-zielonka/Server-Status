<!DOCTYPE html>
<html lang="pl">
<head>
<title>Status</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
<style>
.container-fluid {
    padding: 15px;
}
.progress{
  height: 1.5rem
}
</style>
<script>
  var info = {}
  var block = []

  info.setDisable = module => {
    $('.reload', '#' + module).attr('disabled',true)
    $('.card-body', '#' + module).css('opacity','.4')
  }

  info.setEnable = module => {
    $('.reload', '#' + module).removeAttr('disabled')
    $('.card-body', '#' + module).css('opacity','1')
  }

  info.getModule = (module, fun) => {
    if(!block[module]) {
      block[module] = true
      info.setDisable(module)
      $.get('os/'+module, function (data) {
          info.insertDatas(module, data)

          fun('#' + module, data)

          info.setEnable(module)
          block[module] = false
      }, 'json')
    }
  }

  info.getMemory = () => {
    info.getModule('memory', (card, data) => {
      info.setProgress("-progress-used", card, data.percent_used)
      info.setProgress("-progress-buffers", card, data.percent_buffers)
      info.setProgress("-progress-cached", card, data.percent_cached)
    })
  }

  info.getLoadAverage = () => {
    info.getModule('load-average', (card, data) => {
      info.setProgress("_1", card, Math.round(data[0]*100), true)
      info.setProgress("_5", card, Math.round(data[1]*100), true)
      info.setProgress("_15", card, Math.round(data[2]*100), true)
    })
  }

  info.getAll = () => {
      info.getMemory();
      info.getLoadAverage();
  }

  info.insertDatas = (block, datas) => {
      for (var item in datas) {
          $('#' + block + '-' + item, '#' + block).html(datas[item]);
      }
  }

  info.getColor = percent => {
    if(percent <= 50) return "bg-success"
    else if(percent <= 75) return "bg-warning"
    return "bg-danger"
  }

  info.setProgress = (name, card, percent, colors=false) => {
    var progress = $(card+name, card)
    progress.css('width', percent + '%')
    .html(percent + '%')
    .attr('aria-valuenow', percent)

    if(colors) {
      progress.removeClass("bg-success bg-warning bg-danger")
      .addClass(info.getColor(percent))
    }
  }
</script>
</head>
<body>

<nav class="navbar navbar-light bg-light justify-content-between">
  <a class="navbar-brand" href="/">Status</a>
  <button type="button" onclick="info.getAll()" class="reload btn btn-info">Reload</button>
</nav>

<div class="container-fluid">
  <div class="row">

    <div class="col">
      <div class="card" id="memory">
        <div class="card-header">
          <h4>
            Memory
            <button type="button" onclick="info.getMemory()" class="reload btn btn-info float-right">Reload</button>
          </h4>
        </div>
        <div class="card-body">
        <table class="table table-striped">
            <tbody>
              <tr>
                <td style="width:0;">Used&nbsp;%</td>
                <td>
                  <div class="progress">
                    <div id="memory-progress-used" class="progress-bar bg-success" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                    <div id="memory-progress-buffers" class="progress-bar" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                    <div id="memory-progress-cached" class="progress-bar bg-info" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td>Used</td>
                <td id="memory-used"></td>
              </tr>
              <tr>
                <td>Free</td>
                <td id="memory-free"></td>
              </tr>
              <tr>
                <td>Buffers</td>
                <td id="memory-buffers"></td>
              </tr>
              <tr>
                <td>Cached</td>
                <td id="memory-cached"></td>
              </tr>
              <tr>
                <td>Total&nbsp;Free</td>
                <td id="memory-total_free"></td>
              </tr>
              <tr>
                <td>Total</td>
                <td id="memory-total"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card" id="load-average">
        <div class="card-header">
          <h4>
            Load Average
            <button type="button" onclick="info.getLoadAverage()" class="reload btn btn-info float-right">Reload</button>
          </h4>
        </div>
        <div class="card-body">
        <table class="table table-striped">
            <tbody>
              <tr>
                <td style="width:0;">1&nbsp;min</td>
                <td>
                  <div class="progress">
                    <div id="load-average_1" class="progress-bar bg-success" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td style="width:0;">5&nbsp;min</td>
                <td>
                  <div class="progress">
                    <div id="load-average_5" class="progress-bar bg-success" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td style="width:0;">15&nbsp;min</td>
                <td>
                  <div class="progress">
                    <div id="load-average_15" class="progress-bar bg-success" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                  </div>
                </td>
              </tr>

            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  info.getAll();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pl">
<head>
<title>Status</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
<style>
.progress {
  height: 1.5rem;
}
.card {
  margin-top: 15px;
}
</style>
<script>
  var info = {}
  var block = []

  info.setDisable = module => {
    $('.reload', '#' + module).attr('disabled',true)
    $('.card-body', '#' + module).css('opacity','.4')
  }

  info.setEnable = module => {
    $('.reload', '#' + module).removeAttr('disabled')
    .removeClass('btn-warning')
    .addClass('btn-info')
    $('.card-body', '#' + module).css('opacity','1')
  }

  info.setFail = module => {
    $('.reload', '#' + module).removeAttr('disabled')
    .removeClass('btn-info')
    .addClass('btn-warning')
  }

  info.getModule = (module, fun = (module, data) => {}) => {
    if(!block[module]) {
      block[module] = true
      info.setDisable(module)
      $.get('os/'+module, function (data) {
          fun('#' + module, data)
          info.insertDatas(module, data)

          info.setEnable(module)
          block[module] = false
      }, 'json')
      .fail(() => {
        info.setFail(module)
        block[module] = false
      })
    }
  }

  info.getMemory = () => {
    info.getModule('memory', (card, data) => {
      info.setProgress("-progress-used", card, Math.round((data.active/data.total)*100), true)
      info.setProgress("-progress-buffcache", card, Math.round((data.buffcache/data.total)*100))
      info.setProgress("-progress-swap", card, Math.round((data.swapused/data.swaptotal)*100), true)
      for (var v in data)
        if (data.hasOwnProperty(v))
          data[v] = Math.round((data[v]/1024/1024)*100)/100 + " MB"
    })
  }

  info.getLoadAverage = () => {
    info.getModule('load-average', (card, data) => {
      info.setProgress("_1", card, Math.round(data[0]*100), true)
      info.setProgress("_5", card, Math.round(data[1]*100), true)
      info.setProgress("_15", card, Math.round(data[2]*100), true)
    })
  }

  info.getPm2 = () => {
    info.getModule('pm2', (card, data) => {
      var box = $(card + ' tbody');
      box.empty();

      for (var proces in data.processes) {
          var status_color = data.processes[proces].pm2_env.status == 'online' ? 'badge-success' : 'badge-danger';
          var watch = data.processes[proces].pm2_env.watch ? 'enabled' : 'disabled';
          var watch_color = data.processes[proces].pm2_env.watch ? 'badge-success' : 'badge-secondary';
          var row = `
          <tr>
            <td>${data.processes[proces].name}</td>
            <td>${data.processes[proces].pm_id}</td>
            <td>${data.processes[proces].pm2_env.exec_mode}</td>
            <td><span class="badge ${status_color}">${data.processes[proces].pm2_env.status.toUpperCase()}</span></td>
            <td>${data.processes[proces].pm2_env.restart_time}</td>
            <td>${info.getHumanTime((data.time - data.processes[proces].pm2_env.pm_uptime) / 1000)}</td>
            <td>${data.processes[proces].monit.cpu} %</td>
            <td>${Math.round((data.processes[proces].monit.memory / 1024 / 1024) * 100) / 100} MB</td>
            <td>${data.processes[proces].pm2_env.uid == undefined ? 'root' : data.processes[proces].pm2_env.uid}</td>
            <td><span class="badge ${watch_color}">${watch.toUpperCase()}</span></td>
          <tr/>`
          box.append(row);
      }
    })
  }

  info.getSystem = () => {
    info.getModule('system', (card, data) => {
      $(card+'-uptime', card).html(info.getHumanTime(data.time.uptime));
    })
  }

  info.getVHost = () => {
    info.getModule('vhost', (card, data) => {
      var box = $(card + ' tbody');
      box.empty();

      for (var id in data) {
          var color = 'danger'
          if ((""+data[id].statusCode).match(/^1/)) color = 'info'
          if ((""+data[id].statusCode).match(/^2/)) color = 'success'
          if ((""+data[id].statusCode).match(/^3/)) color = 'warning'
          if ((""+data[id].statusCode).match(/^4/)) color = 'dark'
          if ((""+data[id].statusCode).match(/^5/)) color = 'danger'
          var row = `
          <tr>
            <td>${data[id].port}</td>
            <td><a href="http://${data[id].name}">${data[id].name}</a></td>
            <td><span class="badge badge-${color}">${data[id].statusCode}</span></td>
          <tr/>`
          box.append(row);
      }
    })
  }

  info.getServices = () => {
    info.getModule('services', (card, data) => {
      var box = $(card + ' tbody');
      box.empty();

      for (var id in data) {
          var color = data[id].status ? 'success' : 'danger'
          var color2 = data[id].localhost ? 'success' : 'danger'
          var link = data[id].link ? `<a href="http://${data[id].name}">${data[id].name}</a>` : data[id].name
          var row = `
          <tr>
            <td>${data[id].port}</td>
            <td><span class="badge badge-${color}">${data[id].host}</span>
            <span class="badge badge-${color2}">LOCALHOST</span></td>
            <td>${link}</td>
          <tr/>`
          box.append(row);
      }
    })
  }

  info.getFS = () => {
    info.getModule('fs', (card, data) => {
      var box = $(card + ' tbody');
      box.empty();

      for (var id in data) {
          var use = Math.round(data[id].use)
          var row = `
          <tr>
            <td>${data[id].mount}</td>
            <td>
              <div class="progress">
                <div class="progress-bar bg-success" role="progressbar" aria-valuenow="${use}"
                aria-valuemin="0" aria-valuemax="100" style="width:${use}%">
                  ${use}%
                </div>
              </div>
            </td>
            <td>${data[id].type}</td>
            <td>${info.round(data[id].size/1024/1024/1024,2)}&nbsp;GB</td>
            <td>${info.round(data[id].used/1024/1024/1024,2)}&nbsp;GB</td>
          <tr/>`
          box.append(row);
      }
    })
  }

  info.getAll = () => {
      info.getMemory();
      info.getLoadAverage();
      info.getPm2();
      info.getSystem();
      info.getVHost();
      info.getServices();
      info.getFS();
  }

  info.insertDatas = (block, datas) => {
      for (var item in datas) {
          $('#' + block + '-' + item, '#' + block).html(datas[item]);
      }
  }

  info.getColor = percent => {
    if(percent <= 50) return "bg-success"
    else if(percent <= 75) return "bg-warning"
    return "bg-danger"
  }

  info.setProgress = (name, card, percent, colors=false) => {
    var progress = $(card+name, card)
    progress.css('width', percent + '%')
    .html(percent + '%')
    .attr('aria-valuenow', percent)

    if(colors) {
      progress.removeClass("bg-success bg-warning bg-danger")
      .addClass(info.getColor(percent))
    }
  }

  info.round = (value, precision) => {
    return Math.round(value*(10**precision))/(10**precision)
  }

  info.getHumanTime = (seconds) => {
      var units = {
          'year': 365 * 86400,
          'day': 86400,
          'hour': 3600,
          'minute': 60,
          //'second': 1
      };

      var result = [];

      for (var unit in units) {
          var divisor = units[unit];
          var div = Math.floor(seconds / divisor);

          if (div == 0) continue;
          else {
              if (div == 1) result.push(div + ' ' + unit);
              else result.push(div + ' ' + unit + 's');
              seconds %= divisor;
          }
      }

      return result.join(" ");
  }
</script>
</head>
<body>

<nav class="navbar navbar-light bg-light justify-content-between">
  <a class="navbar-brand" href="/">Status</a>
  <button type="button" onclick="info.getAll()" class="reload btn btn-info">Reload</button>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="col">
      <div class="card" id="system">
        <div class="card-header">
          <h4>
            System
            <button type="button" onclick="info.getSystem()" class="reload btn btn-info float-right">Reload</button>
          </h4>
        </div>
        <div class="card-body">
        <table class="table table-striped">
            <tbody>
              <tr>
                <td>Hostname</td>
                <td id="system-hostname"></td>
              </tr>
              <tr>
                <td>OS</td>
                <td id="system-distro"></td>
              </tr>
              <tr>
                <td>Kernel version</td>
                <td id="system-kernel"></td>
              </tr>
              <tr>
                <td>Uptime</td>
                <td id="system-uptime"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card" id="memory">
        <div class="card-header">
          <h4>
            Memory&amp;Swap
            <button type="button" onclick="info.getMemory()" class="reload btn btn-info float-right">Reload</button>
          </h4>
        </div>
        <div class="card-body">
        <table class="table table-striped">
            <tbody>
              <tr>
                <td>Memory&nbsp;%</td>
                <td class="w-100">
                  <div class="progress">
                    <div id="memory-progress-used" class="progress-bar bg-success" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                    <div id="memory-progress-buffcache" class="progress-bar bg-info" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td>Used</td>
                <td id="memory-active"></td>
              </tr>
              <tr>
                <td>Cached+Buffers</td>
                <td id="memory-buffcache"></td>
              </tr>
              <tr>
                <td>Free</td>
                <td id="memory-free"></td>
              </tr>
              <tr>
                <td>Total</td>
                <td id="memory-total"></td>
              </tr>
              <tr>
                <td style="width:0;">Swap&nbsp;%</td>
                <td>
                  <div class="progress">
                    <div id="memory-progress-swap" class="progress-bar bg-success" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td>Used</td>
                <td id="memory-swapused"></td>
              </tr>
              <tr>
                <td>Free</td>
                <td id="memory-swapfree"></td>
              </tr>
              <tr>
                <td>Total</td>
                <td id="memory-swaptotal"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
    <div class="col">
      <div class="card" id="load-average">
        <div class="card-header">
          <h4>
            Load Average
            <button type="button" onclick="info.getLoadAverage()" class="reload btn btn-info float-right">Reload</button>
          </h4>
        </div>
        <div class="card-body">
        <table class="table table-striped">
            <tbody>
              <tr>
                <td>1&nbsp;min</td>
                <td class="w-100">
                  <div class="progress">
                    <div id="load-average_1" class="progress-bar bg-success" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td>5&nbsp;min</td>
                <td>
                  <div class="progress">
                    <div id="load-average_5" class="progress-bar bg-success" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <td>15&nbsp;min</td>
                <td>
                  <div class="progress">
                    <div id="load-average_15" class="progress-bar bg-success" role="progressbar" aria-valuenow="0"
                    aria-valuemin="0" aria-valuemax="100" style="width:0%">
                      0%
                    </div>
                  </div>
                </td>
              </tr>

            </tbody>
          </table>
        </div>
      </div>

        <div class="card" id="vhost">
            <div class="card-header">
                <h4>
                  VirtualHosts
                  <button type="button" onclick="info.getVHost()" class="reload btn btn-info float-right">Reload</button>
                </h4>
            </div>

            <div class="card-body">
                <table class="table">
                    <thead>
                    <tr>
                        <th>port</th>
                        <th>name</th>
                        <th>status code</th>
                    </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>

        <div class="card" id="services">
            <div class="card-header">
                <h4>
                  Services
                  <button type="button" onclick="info.getServices()" class="reload btn btn-info float-right">Reload</button>
                </h4>
            </div>

            <div class="card-body">
                <table class="table">
                    <thead>
                    <tr>
                        <th>port</th>
                        <th>host</th>
                        <th>name</th>
                    </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>

    </div>
  </div>
  <div class="row">
    <div class="col">


      <div class="card" id="fs">
          <div class="card-header">
              <h4>
                Files system
                <button type="button" onclick="info.getFS()" class="reload btn btn-info float-right">Reload</button>
              </h4>
          </div>

          <div class="card-body">
              <table class="table">
                  <thead>
                  <tr>
                      <th>mount</th>
                      <th class="w-100">use</th>
                      <th>type</th>
                      <th>size</th>
                      <th>used</th>
                  </tr>
                  </thead>
                  <tbody>

                  </tbody>
              </table>
          </div>
      </div>


    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="card" id="pm2">
          <div class="card-header">
              <h4>
                PM2
                <button type="button" onclick="info.getPm2()" class="reload btn btn-info float-right">Reload</button>
              </h4>
          </div>

          <div class="card-body">
              <table class="table table-striped">
                  <thead>
                  <tr>
                      <th>App name</th>
                      <th>id</th>
                      <th>mode</th>
                      <th>status</th>
                      <th>restart</th>
                      <th>uptime</th>
                      <th>cpu</th>
                      <th>mem</th>
                      <th>user</th>
                      <th>watching</th>
                  </tr>
                  </thead>
                  <tbody>

                  </tbody>
              </table>
          </div>
      </div>
    </div>
  </div>
</div>

<script>
  info.getAll();
</script>
</body>
</html>
